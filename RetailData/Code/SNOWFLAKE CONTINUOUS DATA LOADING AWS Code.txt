
CREATE OR REPLACE DATABASE AWS_DATABASE;

USE AWS_DATABASE;

CREATE OR REPLACE TABLE RETAIL_TXNS LIKE AZUREDATABASE.PUBLIC.TRANSACTION_RAW;

CREATE OR REPLACE FILE FORMAT AWS_RETAIL_TXNS_CSV LIKE AZUREDATABASE.PUBLIC.RETAIL_TRNXS_CSV;

CREATE OR REPLACE STORAGE INTEGRATION RETAIL_TXNS_S3_AWS_INT
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER = S3
ENABLED = TRUE
STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::211125783493:role/retail_txns_access_role'
STORAGE_ALLOWED_LOCATIONS = ('s3://retail--raw/');

DESC INTEGRATION RETAIL_TXNS_S3_AWS_INT;

CREATE OR REPLACE STAGE RETAIL_TXNS_STG
URL = 's3://retail--raw/'
FILE_FORMAT = AWS_RETAIL_TXNS_CSV
STORAGE_INTEGRATION = RETAIL_TXNS_S3_AWS_INT;

LIST @RETAIL_TXNS_STG;

SHOW STAGES;

CREATE OR REPLACE PIPE RETAIL_PIPE_TRANSACTION AUTO_INGEST = TRUE AS
COPY INTO AWS_DATABASE.PUBLIC.RETAIL_TXNS  -- COPY INTO YOUR TABLE
FROM '@RETAIL_TXNS_STG/TRANSACTION/'  -- FROM @STAGING NAME FOLLOWED BY SUB FOLDER INSIDE YOUR BUCKET
FILE_FORMAT = AWS_RETAIL_TXNS_CSV;  -- FILE FORMAT

SHOW PIPES;

ALTER PIPE RETAIL_PIPE_TRANSACTION REFRESH;

SELECT COUNT(*) FROM AWS_DATABASE.PUBLIC.RETAIL_TXNS;

SELECT * 
FROM TABLE (INFORMATION_SCHEMA.COPY_HISTORY (TABLE_NAME=> 'AWS_DATABASE.PUBLIC.RETAIL_TXNS',
START_TIME => DATEADD (HOURS, -1, CURRENT_TIMESTAMP())));






